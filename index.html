<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Launamyndir</title>
  <!--<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,700italic,800,800italic" rel="stylesheet" type="text/css">-->
  
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap-theme.min.css">
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
  <style>
    h2 {
        color: black;
        text-align: center;
      }

      .axis {
        font-family: arial;
        font-size: 0.8em;
      }

      path {
        fill: none;
        stroke: black;
        stroke-width: 2px;
      }

      .tick {
        fill: none;
        stroke: black;
      }

      circle {
        opacity: 0.8;
        stroke: black;
        stroke-width: 1;
       
      }

      .line_plot {
        fill: none;
        stroke: #4eb0bb;
        stroke-width: 1px;
      }
      .label {
        width: 150px;
        color: black;
        text-align: left;
      }
      #range {
       -webkit-appearance: slider-vertical;
        width: 20px;
        height: 100px;
      }
      div.left: {
        width: 80%;
        float: left;
      }
      div.right {
        width: 20%;
      }
      .container {
        display: flex;
        flex-direction: row;
      }
  </style>
  <body>
    <h2>Vöxtur launamismunar fyrir fjóra hópa</h2>
    <div class="container">
      <div class="left">
      </div>
      <div class="right">
        <input id="range" type="range" min="15" max="25" value="25" step="1" onchange="update(this.value)" />
      </div>
    </div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.3.13/d3.js"></script>
  <!--<script src="http://dimplejs.org/dist/dimple.v2.0.0.min.js"></script>-->
  <script type="text/javascript">
      function draw(data) {
        "use strict";
          var margin = 60;
          var width = 1000 - margin;
          var height = 600 - margin;

          var radius = 3;
          var color = "blue";

          var tooltip = d3.select("body")
            .append("div")
            .attr("class","label")
            .style("position", "absolute")
            .style("z-index", "10")
            .style("visibility", "hidden")
            .style("background-color","#fff7bc")
            .text("a simple tooltip");

            
            

          var svg = d3.select(".left")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class','chart');


          // Filtering data.
          data = data.map(function(d) {
            var vidmid = data.filter(kennari => kennari.launaflokkur == "5" && kennari.synidaemi == d.synidaemi && kennari.nemendafjoldi == d.nemendafjoldi);
            if (vidmid.length == 1) {
              var referenceSalary = parseFloat(vidmid[0].laun);
              d.mismunur = (parseFloat(d.laun/referenceSalary)-1)*100;
            }
            else {
              var referenceSalary = (parseFloat(vidmid[0].laun) + parseFloat(vidmid[1].laun))/2;
              d.mismunur = (parseFloat(d.laun/referenceSalary)-1)*100;
            }
            return d;
          }); 

          //percentage scale.
          var percentage_scale = d3.scale.linear()
            .range([height, margin])
            .domain([-5,70]);

          var percentage_axis = d3.svg.axis()
            .scale(percentage_scale)
            .orient("left")
            .ticks(10);

          d3.select("svg")
            .append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + margin + ",0)")
            .call(percentage_axis);


          // ordinal axis
          var ordinal_scale = d3.scale.ordinal()
          .rangePoints([margin,width-margin])
          .domain(['','2013','Félagsgreinar','Íslenska','Raungreinar','Stærðfræði','Tungumál']);
          

          var ordinal_axis = d3.svg.axis()
            .scale(ordinal_scale)
            .orient("bottom");


           d3.select("svg")
            .append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + (height-31) + ")")
            .call(ordinal_axis);
          
          var update = function(nemfjoldi) {
            
            var filtered = data.filter(d => d.nemendafjoldi == (nemfjoldi + "") || d.synidaemi == "2013"); 
            
            var circles = svg.selectAll("circle").data(filtered, function(d) {
              return d['key'];
            });

            circles.exit().remove();
            circles.enter().append("circle")
            .attr('cx',function(d) {
                if (d['aldursflokkur'] == '30 ára-')
                  return ordinal_scale(d['synidaemi'])- 60;
                else if (d['aldursflokkur'] == '30-37 ára')
                  return ordinal_scale(d['synidaemi']) - 50;
                else if (d['aldursflokkur'] == '38-54 ára')
                  return ordinal_scale(d['synidaemi'])-40;  
                else if (d['aldursflokkur'] == '55-60 ára')
                  return ordinal_scale(d['synidaemi'])-30 ; 
                else
                  return ordinal_scale(d['synidaemi'])-20; 


            })
            .attr('cy',function(d) {
              return percentage_scale(d['mismunur']);
            })
            .attr('r',5)
            .attr('fill',function(d) {
              var aldurslitir = {
                '30 ára-': "#d7191c",
                '30-37 ára': "#fdae61",
                '38-54 ára':  "#ffffbf",
                '55-59 ára': "#abd9e9",
                '60 ára+': "#2c7bb6"
              };
              return aldurslitir[d['aldursflokkur']];
            })
            .attr("transform", "translate(50,0)")
            .attr("id",function(d) {
              return d['key'] + "";
            })
            .on("mouseover", function() {
              var id = this.id;
              var item = data.filter(d=> d.key == id)[0];
              tooltip[0][0].innerHTML = "Aldursflokkur: " + item.aldursflokkur + "<br>Mismunur: " + parseInt(item.mismunur) + "%<br>";
              tooltip[0][0].innerHTML += "Launaflokkur: " + item.launaflokkur +", þrep: " + item.threp + "<br>";
              tooltip[0][0].innerHTML += "Laun: " + parseFloat(item.laun).toFixed(0) + "<br>";
              if (item.synidaemi != "2013") {
                tooltip[0][0].innerHTML += "Vinnumat: " + parseFloat(item.vinnumat).toFixed(0) + "<br>";
                console.log(item.skertur);
                tooltip[0][0].innerHTML += (item.skertur == "True" ? "Skert vinnumat": "Óskert vinnumat");

              }
              else {
                tooltip[0][0].innerHTML += "Kennsluskylda: " + item.kennsluskylda;

              }
              return tooltip.style("visibility", "visible");
            })
            .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
            .on("mouseout", function(){return tooltip.style("visibility", "hidden");});
            

          };
        
          var nemfjoldi = [];

          for(var i = 15; i < 26; i++) {
            nemfjoldi.push(i);
          }
          //console.log(nemfjoldi);

          var fj_idx = 0;

          var nem_interval = setInterval(function() {
            d3.select("body")
             .selectAll("h2")
             .text("Vöxtur launamismunar fyrir fjóra hópa. Fjöldi " + nemfjoldi[fj_idx] + ".");
            update(nemfjoldi[fj_idx]);
             

            fj_idx++;
            //console.log(nemfjoldi[fj_idx]);
            if(fj_idx == nemfjoldi.length) {
                clearInterval(nem_interval);
                
            }
          }, 1000);
          /*
          d3.select(".right")
                  .append("input")
                  .attr("type","range")
                  .attr("id","range")
                  .attr("min","15")
                  .attr("max","32")
                  .attr("step","1")
                  .attr("value","25")
                  .attr("onchange","update(this.value)");*/
     };
  </script>
  <script type="text/javascript">
    d3.tsv("/data/kjaramal.tsv",draw);
  </script>
</html>
